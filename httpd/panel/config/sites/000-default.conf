<VirtualHost _default_:80>
  
    ServerName ${LAB_DOMAIN}

    RewriteEngine On
    # RewriteCond %{HTTP:Upgrade} =websocket [NC]
    # RewriteCond %{HTTP:Upgrade} !=websocket [NC]
    # RewriteCond %{HTTP:UPGRADE} ^WebSocket$ [NC,OR]
    # RewriteCond %{HTTP:CONNECTION} ^Upgrade$ [NC]
    # RewriteCond %{REQUEST_URI} !^/\.well\-known/acme\-challenge/
    # RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]

    Redirect permanent / https://${LAB_DOMAIN}/

</VirtualHost>

<VirtualHost _default_:443>
  
    ServerName ${LAB_DOMAIN}

    Protocols h2 http/1.1

    <Proxy *>
        Order deny,allow
        Allow from all
    </Proxy>

    ProxyPreserveHost On

    ErrorDocument 404 /404.html
    ErrorDocument 503 /503.html

    AllowEncodedSlashes NoDecode

    ErrorLog logs/error.log
    CustomLog logs/access.log combined

    <Directory /usr/local/apache2/htdocs>
        Allowoverride all
    </Directory>

    ProxyPass           /adminer    http://adminer:80
    ProxyPassReverse    /adminer    http://adminer:80

    ProxyPass           /git        http://gitea:3000
    ProxyPassReverse    /git        http://gitea:3000

    ProxyPass           /commander  http://commander:8081/commander
    ProxyPassReverse    /commander  http://commander:8081/commander

    ProxyPass           /locust     http://locust:8089/
    ProxyPassReverse    /locust     http://locust:8089/

    ProxyPass           /nextcloud  http://nextcloud:80
    ProxyPassReverse    /nextcloud  http://nextcloud:80

    ProxyPass           /portainer  http://portainer:9000
    ProxyPassReverse    /portainer  http://portainer:9000

    ProxyPass           /registry   http://containers:80
    ProxyPassReverse    /registry   http://containers:80

    ProxyPass           /54377      http://172.17.0.1:54377
    ProxyPassReverse    /54377      http://172.17.0.1:54377

    SSLEngine on
    SSLCertificateFile "certificates/live/${LAB_DOMAIN}/fullchain.pem"
    SSLCertificateKeyFile "certificates/live/${LAB_DOMAIN}/privkey.pem"

</VirtualHost>
