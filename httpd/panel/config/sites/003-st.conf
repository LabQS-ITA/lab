<VirtualHost _default_:80>

    ServerName ${ST_LAB_DOMAIN}

    Protocols http/1.1

    RedirectMatch permanent ^/(.*)$ https://${ST_LAB_DOMAIN}/$1

</VirtualHost>

<Proxy balancer://miniows>
    BalancerMember "wss://minio01:9000"
    BalancerMember "wss://minio02:9000"
    ProxySet lbmethod=byrequests
</Proxy>

<VirtualHost _default_:443>

    ServerName ${ST_LAB_DOMAIN}

    Protocols http/1.1

    ProxyRequests Off
    ProxyVia Block
    ProxyPreserveHost On

    RequestHeader set X-Forwarded-Proto “https”
    RequestHeader set X-Forwarded-Port "9000"

    RemoteIPHeader X-Forwarded-For
    RemoteIPHeader X-Forwarded-Proto
    RemoteIPHeader X-Forwarded-Port
    RemoteIPHeader X-Real-IP

    RewriteEngine on
    RewriteCond ${HTTP:Upgrade} =websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule /(.*) balancer://miniows/$1 [P,L]

    ProxyPass / balancer://miniows
    ProxyPassReverse balancer://miniows

    SSLEngine on

    SSLCertificateFile certificates/live/${ST_LAB_DOMAIN}/fullchain.pem
    SSLCertificateKeyFile certificates/live/${ST_LAB_DOMAIN}/privkey.pem

    Header always set Strict-Transport-Security max-age=63072000

</VirtualHost>
