<VirtualHost _default_:80>

    ServerName ${ST_LAB_DOMAIN}

    RedirectMatch permanent /(.*)$ https://${ST_LAB_DOMAIN}/

</VirtualHost>

<VirtualHost _default_:443>

    ServerName ${ST_LAB_DOMAIN}

    <Proxy balancer://miniows>
        BalancerMember ws://minio01:9000 route=1
        BalancerMember ws://minio02:9000 route=2
        BalancerMember ws://minio03:9000 route=3
        BalancerMember ws://minio04:9000 route=4
        ProxySet stickysession=ROUTEID
        ProxySet lbmethod=byrequests
    </Proxy>

    RewriteEngine on
    RewriteCond ${HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*) balancer://miniows/$1 [P,L]

    SSLEngine on

    SSLCertificateFile certificates/live/${ST_LAB_DOMAIN}/fullchain.pem
    SSLCertificateKeyFile certificates/live/${ST_LAB_DOMAIN}/privkey.pem

    Protocols h2 http/1.1

    Header always set Strict-Transport-Security max-age=63072000

</VirtualHost>