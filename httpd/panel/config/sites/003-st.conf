<VirtualHost _default_:80>

    ServerName ${ST_LAB_DOMAIN}

    # RedirectMatch permanent ^/(.*)$ https://${ST_LAB_DOMAIN}/$1

</VirtualHost>

<VirtualHost _default_:9000>

    ServerName ${ST_LAB_DOMAIN}

    <Proxy balancer://miniows>
        BalancerMember ws://minio01:9000
        BalancerMember ws://minio02:9000
        ProxySet lbmethod=byrequests
    </Proxy>

    # RewriteEngine on
    # RewriteCond ${HTTP:Upgrade} websocket [NC]
    # RewriteCond %{HTTP:Connection} upgrade [NC]
    # RewriteRule ^/?(.*) balancer://miniows/$1 [P,L]
    
    ProxyPass / balancer://miniows
    ProxyPassReverse / balancer://miniows

</VirtualHost>

<VirtualHost _default_:443>

    ServerName ${ST_LAB_DOMAIN}

    # ProxyRequests Off
    # ProxyVia Block
    # ProxyPreserveHost On

    RequestHeader set X-Forwarded-Proto “https”
    RequestHeader set X-Forwarded-Port “443”

    RemoteIPHeader X-Forwarded-For
    RemoteIPHeader X-Forwarded-Proto
    RemoteIPHeader X-Forwarded-Port
    RemoteIPHeader X-Real-IP
    
    <Proxy "balancer://miniohttp">
        BalancerMember "http://minio01:9001"
        BalancerMember "http://minio02:9001"
        ProxySet lbmethod=byrequests
    </Proxy>

    ProxyPass /console balancer://miniohttp
    ProxyPassReverse /console balancer://miniohttp

    # <Proxy balancer://miniows>
    #     BalancerMember ws://minio01:9000
    #     BalancerMember ws://minio02:9000
    #     ProxySet lbmethod=byrequests
    # </Proxy>

    # # RewriteEngine on
    # # RewriteCond ${HTTP:Upgrade} websocket [NC]
    # # RewriteCond %{HTTP:Connection} upgrade [NC]
    # # RewriteRule ^/?(.*) balancer://miniows/$1 [P,L]
    
    # ProxyPass / balancer://miniows
    # ProxyPassReverse / balancer://miniows

    <Location /bm>

        SetHandler balancer-manager
        Require all granted

    </Location>

    ProxyPass /bm !

    SSLEngine on

    SSLCertificateFile certificates/live/${ST_LAB_DOMAIN}/fullchain.pem
    SSLCertificateKeyFile certificates/live/${ST_LAB_DOMAIN}/privkey.pem

    Protocols h2 http/1.1

    Header always set Strict-Transport-Security max-age=63072000

</VirtualHost>