<VirtualHost _default_:80>

    ServerName ${ST_C_LAB_DOMAIN}

    Protocols http/1.1

    # RedirectMatch permanent ^/(.*)$ https://${ST_C_LAB_DOMAIN}/$1

</VirtualHost>

<VirtualHost _default_:443>

    ServerName ${ST_C_LAB_DOMAIN}

    Protocols http/1.1 h2

    ProxyRequests Off
    ProxyVia Block
    ProxyPreserveHost On

    <Proxy *>
         Require all granted
    </Proxy>

    RewriteEngine on

    RemoteIPHeader X-Real-IP
    RemoteIPHeader X-Forwarded-For
    RemoteIPHeader X-Forwarded-Proto

    RequestHeader set Host ${ST_C_LAB_DOMAIN}

    RewriteCond ${HTTP:Upgrade} ^WebSocket$ [NC,OR]
    RewriteCond %{HTTP:Connection} ^Upgrade$ [NC]
    RewriteRule /(.*) ws://console:9090/$1 [P,L]

    ProxyPass / http://console:9090/
    ProxyPassReverse / http://console:9090/

    SSLEngine on

    SSLCertificateFile certificates/live/${ST_C_LAB_DOMAIN}/fullchain.pem
    SSLCertificateKeyFile certificates/live/${ST_C_LAB_DOMAIN}/privkey.pem

</VirtualHost>
