<VirtualHost _default_:80>

    ServerName ${LAB_DOMAIN}

    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/\.well\-known/acme\-challenge/
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]

</VirtualHost>

<VirtualHost _default_:443>

    ServerName ${LAB_DOMAIN}

    ProxyPass /keystone http://keystone:5001/
    ProxyPassReverse /keystone http://keystone:5001/
    
    SSLEngine on
    SSLCertificateFile "certificates/live/${LAB_DOMAIN}/fullchain.pem"
    SSLCertificateKeyFile "certificates/live/${LAB_DOMAIN}/privkey.pem"

    Protocols h2 http/1.1

    Header always set Strict-Transport-Security "max-age=63072000"

</VirtualHost>
