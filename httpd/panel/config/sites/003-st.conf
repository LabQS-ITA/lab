<VirtualHost _default_:80>

    ServerName ${ST_LAB_DOMAIN}

    RedirectMatch permanent /(.*)$ https://${ST_LAB_DOMAIN}/

</VirtualHost>

<VirtualHost _default_:443>

    ServerName ${ST_LAB_DOMAIN}

    Protocols h2 http/1.1

    Header always set Strict-Transport-Security "max-age=63072000"

    RequestHeader set "X-Forwarded-Proto" expr=%{REQUEST_SCHEME}
    RequestHeader set "X-Forwarded-SSL" expr=%{HTTPS}

    SSLEngine on
    SSLCertificateFile "certificates/live/${ST_LAB_DOMAIN}/fullchain.pem"
    SSLCertificateKeyFile "certificates/live/${ST_LAB_DOMAIN}/privkey.pem"

    RewriteEngine On
    RewriteCond %{HTTP:UPGRADE} ^WebSocket$ [NC]
    RewriteCond %{HTTP:CONNECTION} ^Upgrade$ [NC,OR]

    ProxyRequests On
    ProxyPreserveHost On
    ProxyVia On

    AllowEncodedSlashes NoDecode
    
    RewriteRule .* ws://${SERVICE_NAME}:${SERVICE_PORT}%{REQUEST_URI} [P,L]

    ProxyPass / http://minio01:9001/
    ProxyPassReverse / http://minio01:9001/

</VirtualHost>
