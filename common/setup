#!/usr/bin/env bash
set -euo pipefail

if [[ $# -ne 1 && $# -ne 2 ]]; then

    echo "Informe { dev | tst | hom | ia } [ config ]"

    exit 1

elif [ "$1" == "tst" ]; then

    # Servidor do lab
    export LAB_DOMAIN=test.labqs.ita.br
    export CI_LAB_DOMAIN=ci.test.labqs.ita.br
    export CM_LAB_DOMAIN=cm.test.labqs.ita.br
    export IA_LAB_DOMAIN=ia.labqs.ita.br

elif [ "$1" == "dev" ]; then

    # Servidores de desenvolvimento e testes
    export LAB_DOMAIN=dev.labqs.ita.br
    export CI_LAB_DOMAIN=ci.labqs.ita.br
    export CM_LAB_DOMAIN=cm.labqs.ita.br
    export IA_LAB_DOMAIN=ia.labqs.ita.br

elif [ "$1" == "hom" ]; then

    # Servidores de homologação
    export LAB_DOMAIN=labqs.ita.br
    export CI_LAB_DOMAIN=ci.labqs.ita.br
    export CM_LAB_DOMAIN=cm.labqs.ita.br
    export IA_LAB_DOMAIN=ia.labqs.ita.br

elif [ "$1" == "ia" ]; then

    # Servidor do lab
    export LAB_DOMAIN=ia.labqs.ita.br
    export CI_LAB_DOMAIN=ci.labqs.ita.br
    export CM_LAB_DOMAIN=cm.labqs.ita.br
    export IA_LAB_DOMAIN=ia.labqs.ita.br
        
else

    echo "Argumento $1 incorreto. Use [ dev | tst | hom | ia ]"

    exit 1

fi

CONFIG_ENV="N"

if [ $# -eq 2 ]; then
    if [ "$2" == "config" ]; then
        echo "$(tput setaf 1)Configurando ambientes$(tput sgr0)"
        read -p "Confirme [S/N]: " -n1 CONFIG_OPT
        CONFIG_OPT=${CONFIG_OPT:-N}
        if [[ $CONFIG_OPT =~ ^[Ss]$ ]]; then
            echo '\nTodos os ambientes serão configurados'
            CONFIG_ENV="Y"
        fi
    else

        echo "Argumento $2 incorreto. Use [ config ]"

        exit 2
        
    fi

else

    echo "$(tput setaf 1)Atualizando ambientes sem reconfigurar$(tput sgr0)"

fi

source ./config

source ./functions

echo "Registrar domínios $(tput setaf 1)"$LAB_DOMAIN"$(tput sgr0)"

sed -i 's/@LAB_DOMAIN/'$LAB_DOMAIN'/g' ../httpd/panel/static/index.html
sed -i 's/@CI_LAB_DOMAIN/'$CI_LAB_DOMAIN'/g' ../httpd/panel/static/index.html
sed -i 's/@CM_LAB_DOMAIN/'$CM_LAB_DOMAIN'/g' ../httpd/panel/static/index.html
sed -i 's/@IA_LAB_DOMAIN/'$IA_LAB_DOMAIN'/g' ../httpd/panel/static/index.html


httpd $1 $CONFIG_ENV

if [ "$1" != "ia" ]; then
    
    postgres $1 $CONFIG_ENV

    mongodb $1 $CONFIG_ENV

    mariadb $1 $CONFIG_ENV

    redis $1 $CONFIG_ENV

    # memcached $1 $CONFIG_ENV

    etcd $1 $CONFIG_ENV

    # rabbitmq $1 $CONFIG_ENV

    nextcloud $1 $CONFIG_ENV

    hasura $1 $CONFIG_ENV

fi

agent $1 $CONFIG_ENV


if [ "$1" == "ia" ]; then

    jupyter $1 $CONFIG_ENV

fi

if [ "$1" == "dev" ] || [ "$1" == "tst" ]; then

    gitea $1 $CONFIG_ENV

    drone $1 $CONFIG_ENV

    # semaphore $1 $CONFIG_ENV

    # registry $1 $CONFIG_ENV

    # locust $1 $CONFIG_ENV

    redmine $1 $CONFIG_ENV

    prometheus $1 $CONFIG_ENV

    grafana $1 $CONFIG_ENV

    netdata $1 $CONFIG_ENV

    portainer $1 $CONFIG_ENV

    # opennebula $1 $CONFIG_ENV

fi
