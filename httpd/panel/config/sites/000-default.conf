<VirtualHost *:80>
  
    ServerName ${LAB_DOMAIN}

    Redirect permanent / https://${LAB_DOMAIN}/

</VirtualHost>

<VirtualHost *:443>
  
    ServerName ${LAB_DOMAIN}

    Protocols h2 http/1.1

    RequestHeader set "X-Forwarded-Proto" expr=%{REQUEST_SCHEME}
    RequestHeader set "X-Forwarded-SSL" expr=%{HTTPS}
    
    SSLEngine on
    SSLCertificateFile "certificates/live/${LAB_DOMAIN}/fullchain.pem"
    SSLCertificateKeyFile "certificates/live/${LAB_DOMAIN}/privkey.pem"

    <Proxy *>
        Order deny,allow
        Allow from all
    </Proxy>

    RewriteEngine On
    RewriteCond %{HTTPS} !=on
    RewriteCond %{HTTP:UPGRADE} ^WebSocket$ [NC,OR]
    RewriteCond %{HTTP:CONNECTION} ^Upgrade$ [NC]
    RewriteCond %{REQUEST_URI} !^/\.well\-known/acme\-challenge/
    RewriteRule ^/?(.*) https://${LAB_DOMAIN}/$1 [END,NE,R=permanent]

    ProxyPreserveHost On

    ErrorDocument 404 /404.html
    ErrorDocument 503 /503.html

    AllowEncodedSlashes NoDecode

    ErrorLog logs/error.log
    CustomLog logs/access.log combined

    <Directory /usr/local/apache2/htdocs>
        Allowoverride all
    </Directory>

    ProxyPass /git http://gitea:3000
    ProxyPassReverse /git http://gitea:3000

    ProxyPass /locust http://locust:8089/
    ProxyPassReverse /locust http://locust:8089/

    ProxyPass /nextcloud http://nextcloud:80
    ProxyPassReverse /nextcloud http://nextcloud:80

    RewriteRule /jupyter/(.*) ws://jupyter:8000/jupyter/$1 [P,L]
    RewriteRule /jupyter/(.*) http://jupyter:8000/jupyter/$1 [P,L]

    ProxyPass /jupyter http://jupyter:8000/jupyter/
    ProxyPassReverse /jupyter http://jupyter:8000/jupyter/

    ProxyPass /portainer http://portainer:9000
    ProxyPassReverse /portainer http://portainer:9000

    ProxyPass /registry http://containers:80
    ProxyPassReverse /registry http://containers:80

    ProxyPass /rabbitmq/api http://rabbitmng:15672/api
    ProxyPass /rabbitmq http://rabbitmng:15672
    ProxyPassReverse /rabbitmq http://rabbitmng:15672

    ProxyPass /redmine http://redmine:3000/redmine
    ProxyPassReverse /redmine http://redmine:3000/redmine

    ProxyPass /grafana http://grafana:3001
    ProxyPassReverse /grafana http://grafana:3001

</VirtualHost>
