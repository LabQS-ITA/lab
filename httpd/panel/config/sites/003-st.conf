<VirtualHost _default_:80>

    ServerName ${ST_LAB_DOMAIN}

    RedirectMatch permanent /(.*)$ https://${ST_LAB_DOMAIN}/

</VirtualHost>

<VirtualHost _default_:443>

    ServerName ${ST_LAB_DOMAIN}

    Protocols h2 http/1.1

    Header always set Strict-Transport-Security "max-age=63072000"

    RequestHeader set "X-Forwarded-Proto" expr=%{REQUEST_SCHEME}
    RequestHeader set "X-Forwarded-SSL" expr=%{HTTPS}

    SSLEngine on
    SSLCertificateFile "certificates/live/${ST_LAB_DOMAIN}/fullchain.pem"
    SSLCertificateKeyFile "certificates/live/${ST_LAB_DOMAIN}/privkey.pem"

    RewriteEngine On
    RewriteCond %{HTTP:CONNECTION} ^Upgrade$ [NC,OR]
    RewriteCond %{REQUEST_URI} !^/\.well\-known/acme\-challenge/

    ProxyRequests On

    AllowEncodedSlashes NoDecode
    
    RewriteRule /(.*) ws://minio01:9000/$1 [P,L]
    RewriteRule /(.*) http://minio01:9001/$1 [P,L]

    ProxyPass / http://minio01:9001/
    ProxyPassReverse / http://minio01:9001/

</VirtualHost>
