<VirtualHost _default_:80>

    ServerName ${ST_LAB_DOMAIN}

    RedirectMatch permanent /(.*)$ https://${ST_LAB_DOMAIN}/

</VirtualHost>

<VirtualHost _default_:443 _default:9000>

    ServerName ${ST_LAB_DOMAIN}

    <Proxy "balancer://miniows">
        BalancerMember "ws://minio01:9000"
        BalancerMember "ws://minio02:9000"
        BalancerMember "ws://minio03:9000"
        BalancerMember "ws://minio04:9000"
    </Proxy>

    RewriteEngine on
    RewriteCond ${HTTP:Upgrade} websocket [NC]
    RewriteCond ${HTTP:Connection} upgrade [NC]
    RewriteRule .* "balancer://miniows/$1" [P,L]

    ProxyPass /ws balancer://miniows/ws
    ProxyPassReverse /ws balancer://miniows/ws
    ProxyRequests off

    <Proxy "balancer://miniohttp">
        BalancerMember "http://minio01:9001"
        BalancerMember "http://minio02:9001"
        BalancerMember "http://minio03:9001"
        BalancerMember "http://minio04:9001"
    </Proxy>

    ProxyPass / balancer://miniohttp/
    ProxyPassReverse / balancer://miniohttp/

    SSLEngine on

    SSLCertificateFile "certificates/live/${ST_LAB_DOMAIN}/fullchain.pem"
    SSLCertificateKeyFile "certificates/live/${ST_LAB_DOMAIN}/privkey.pem"

    Protocols h2 http/1.1

    Header always set Strict-Transport-Security "max-age=63072000"

</VirtualHost>