<VirtualHost _default_:80>

    ServerName ${ST_LAB_DOMAIN}

    Protocols http/1.1

    RedirectMatch permanent ^/(.*)$ https://${ST_LAB_DOMAIN}/$1

</VirtualHost>

<Proxy balancer://miniows>
    BalancerMember "ws://minio01:9000"
    BalancerMember "ws://minio02:9000"
    ProxySet lbmethod=byrequests
</Proxy>

<Proxy "balancer://miniohttp">
    BalancerMember "http://minio01:9001"
    BalancerMember "http://minio02:9001"
    ProxySet lbmethod=byrequests
</Proxy>

<VirtualHost _default_:443>

    ServerName ${ST_LAB_DOMAIN}

    Protocols http/1.1

    ProxyRequests Off
    ProxyVia Block
    ProxyPreserveHost On

    RequestHeader set X-Forwarded-Proto “https”
    RequestHeader set X-Forwarded-Port “443”

    RemoteIPHeader X-Forwarded-For
    RemoteIPHeader X-Forwarded-Proto
    RemoteIPHeader X-Forwarded-Port
    RemoteIPHeader X-Real-IP

    # <Proxy balancer://miniows>
    #     BalancerMember ws://minio01:9000
    #     BalancerMember ws://minio02:9000
    #     ProxySet lbmethod=byrequests
    # </Proxy>

    RewriteEngine on
    RewriteCond ${HTTP:Upgrade} =websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    # RewriteRule /api/(.*) balancer://miniows/api/$1 [P,L]
    # RewriteRule /api/(.*) ws://minio01:9000/api/$1 [P,L]
    
    # ProxyPass /api ws://minio01:9000/api
    # ProxyPassReverse /api ws://minio01:9000/api
    
    ProxyPass /console http://minio01:9001
    ProxyPassReverse /console http://minio01:9001

    SSLEngine on

    SSLCertificateFile certificates/live/${ST_LAB_DOMAIN}/fullchain.pem
    SSLCertificateKeyFile certificates/live/${ST_LAB_DOMAIN}/privkey.pem

    Header always set Strict-Transport-Security max-age=63072000

</VirtualHost>

# <VirtualHost _default_:443>

#     ServerName ${ST_LAB_DOMAIN}

#     Protocols http/1.1

#     ProxyRequests Off
#     ProxyVia Block
#     ProxyPreserveHost On

#     RequestHeader set X-Forwarded-Proto “https”
#     RequestHeader set X-Forwarded-Port “443”

#     RemoteIPHeader X-Forwarded-For
#     RemoteIPHeader X-Forwarded-Proto
#     RemoteIPHeader X-Forwarded-Port
#     RemoteIPHeader X-Real-IP

#     <Proxy balancer://miniows>
#         BalancerMember ws://minio01:9000
#         BalancerMember ws://minio02:9000
#         ProxySet lbmethod=byrequests
#     </Proxy>

#     <Proxy "balancer://miniohttp">
#         BalancerMember "http://minio01:9001"
#         BalancerMember "http://minio02:9001"
#         ProxySet lbmethod=byrequests
#     </Proxy>

#     RewriteEngine on
#     RewriteCond ${HTTP:Upgrade} websocket [NC]
#     RewriteCond %{HTTP:Connection} upgrade [NC]

#     ProxyPass /console balancer://miniohttp
#     ProxyPassReverse /console balancer://miniohttp

#     SSLEngine on

#     SSLCertificateFile certificates/live/${ST_LAB_DOMAIN}/fullchain.pem
#     SSLCertificateKeyFile certificates/live/${ST_LAB_DOMAIN}/privkey.pem

#     Header always set Strict-Transport-Security max-age=63072000

# </VirtualHost>
