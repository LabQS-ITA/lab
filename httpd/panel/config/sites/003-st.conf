<VirtualHost _default_:80>

    ServerName ${ST_LAB_DOMAIN}

    Protocols http/1.1

    RedirectMatch permanent ^/(.*)$ https://${ST_LAB_DOMAIN}/$1

</VirtualHost>

<VirtualHost _default_:443>

    ServerName ${ST_LAB_DOMAIN}

    ProxyRequests Off
    ProxyVia Block
    ProxyPreserveHost On

    <Proxy *>
         Require all granted
    </Proxy>

    <Proxy balancer://miniows>
        BalancerMember ws://minio01:9000 flushpackets=on
        BalancerMember ws://minio02:9000 flushpackets=on
        ProxySet lbmethod=byrequests
    </Proxy>

    ProxyPass / balancer://miniows
    ProxyPassReverse / balancer://miniows

    RemoteIPHeader X-Forwarded-For

    SSLEngine on

    SSLCertificateFile certificates/live/${ST_LAB_DOMAIN}/fullchain.pem
    SSLCertificateKeyFile certificates/live/${ST_LAB_DOMAIN}/privkey.pem

</VirtualHost>

# <VirtualHost _default_:443>

#     ServerName ${ST_LAB_DOMAIN}

#     Protocols http/1.1

#     Header always set Strict-Transport-Security "max-age=63072000"

#     ProxyPreserveHost On
#     RewriteEngine on

#     RemoteIPHeader X-Real-IP
#     RemoteIPHeader X-Forwarded-For
#     RemoteIPHeader X-Forwarded-Proto

#     RequestHeader set Host ${ST_LAB_DOMAIN}

#     RewriteCond ${HTTP:Upgrade} ^WebSocket$ [NC,OR]
#     RewriteCond %{HTTP:Connection} ^Upgrade$ [NC]
#     RewriteRule /(.*) balancer://miniows/$1 [P,L]

#     <Proxy balancer://miniows>
#         BalancerMember ws://minio01:9000 flushpackets=on
#         BalancerMember ws://minio02:9000 flushpackets=on
#         ProxySet lbmethod=byrequests
#     </Proxy>

#     ProxyPass / balancer://miniows
#     ProxyPassReverse / balancer://miniows

#     SSLEngine on

#     SSLCertificateFile certificates/live/${ST_LAB_DOMAIN}/fullchain.pem
#     SSLCertificateKeyFile certificates/live/${ST_LAB_DOMAIN}/privkey.pem

# </VirtualHost>
