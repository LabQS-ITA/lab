<VirtualHost _default_:80>

    ServerName ${CM_LAB_DOMAIN}

    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/\.well\-known/acme\-challenge/
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]

</VirtualHost>

<VirtualHost _default_:443>

    ServerName ${CM_LAB_DOMAIN}

    ProxyPass /api/ws ws://semaphore:3000/api/ws
    ProxyPassReverse /api/ws ws://semaphore:3000/api/ws
    
    ProxyPass / http://semaphore:3000/
    ProxyPassReverse / http://semaphore:3000/

    SSLEngine on

    SSLCertificateFile "certificates/live/${CM_LAB_DOMAIN}/fullchain.pem"
    SSLCertificateKeyFile "certificates/live/${CM_LAB_DOMAIN}/privkey.pem"

    Protocols h2 http/1.1

    Header always set Strict-Transport-Security "max-age=63072000"

</VirtualHost>
